---
# tasks file for jitsi-meet
- name: Install some dependencies for Jitsi Meet
  apt:                                                                          
    name: "{{ item }}"                                                          
    state: present    
  with_items:                                      
    - git
    - build-essential

- name: Install some dependencies for Jitsi Meet                                
  apt:                                                                          
    name: "{{ item }}"                                                          
    state: present
    update_cache: yes                                                              
  with_items:                                                                   
    - nodejs-legacy
    - npm

- name: Clone git repository for Jitsi Meet
  git:                                                                          
    repo: https://github.com/jitsi/jitsi-meet
    dest: /var/www/jitsi
    version: master
    force: yes                                            
    depth: 1
 
- name: Install Node.js dependencies
  command: npm install --production
  args:                                      
    chdir: /var/www/jitsi

- name: Apply patches to remove third party resources
  patch:
    src: "{{ item }}"
    basedir: /var/www/jitsi
  with_items:
    - 0001-Ripped-out-all-references-to-CallStats.io.patch
    - 0001-Remove-Google-Analytics.patch
    - 0001-Removed-Gravatar-images.patch
  ignore_errors: yes

- name: Build the Jitsi Meet application                                        
  command: make                                                                 
  args:                                                                         
    chdir: /var/www/jitsi
  ignore_errors: yes
